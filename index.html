<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Plugin Comprovante Kinbox</title>

    <!-- SDK oficial do Kinbox -->
    <script
      type="text/javascript"
      src="https://andrody.github.io/kinbox-lib/kinboxjs.js"
    ></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #111;
        color: #0f0;
        padding: 10px;
      }
      h2 {
        color: #0ff;
      }
      #log {
        white-space: pre-wrap;
        font-size: 14px;
        line-height: 1.4em;
        background: #000;
        padding: 10px;
        border-radius: 8px;
        max-height: 500px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h2>üì° Plugin de Captura de Comprovantes</h2>
    <div id="log">Iniciando plugin...</div>

    <!-- Carrega o plugin -->
    <script type="text/javascript">
      function logMsg(msg, obj) {
        console.log(msg, obj || "")
        const logDiv = document.getElementById("log")
        if (logDiv) {
          logDiv.innerHTML += "\n" + msg + (obj ? " " + JSON.stringify(obj, null, 2) : "")
          logDiv.scrollTop = logDiv.scrollHeight
        }
      }

      // Escuta o evento do Kinbox
      Kinbox.on("conversation", function (data) {
        logMsg("üì© Nova conversa recebida:", { contato: data.contact?.name, conversa: data.conversation?.id })

        const conversaId = data.conversation?.id
        if (!conversaId) {
          logMsg("‚ö†Ô∏è Nenhum ID de conversa encontrado.")
          return
        }

        const payload = {
          token: "ak_live_NjEvp8gn2YAax4q11bzCq7yi0LyFX5vPXPAtcEV_DglI3fSoYk",
          contato: {
            id: data.contact?.id,
            nome: data.contact?.name,
            telefone: data.contact?.phone
          },
          metadata: {
            conversaId,
            tags: data.conversation?.tags || []
          }
        }

        logMsg("üì§ Enviando ID da conversa para n8n...", payload)

        fetch("https://n8n.srv1025988.hstgr.cloud/webhook/kinbox/comprovantes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(res => logMsg("üéØ Payload enviado com sucesso. Status: " + res.status))
          .catch(err => logMsg("‚ùå Erro ao enviar para o n8n: " + err.message))
      })

      Kinbox.on("no_conversation", function () {
        logMsg("‚ÑπÔ∏è Nenhuma conversa ativa.")
      })
    </script>
  </body>
</html>
